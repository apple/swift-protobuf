name: Build and Test

permissions:
  contents: read

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  core:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # We "float" the bug fix so we pick up new ones. This helps since the GitHub CI
        # is set to ensure the actions pass, thus updates are only needed when the
        # "major.minor" pairs changes.
        #
        # Looking at https://hub.docker.com/_/swift, the version only tags (i.e. - 6.1)
        # could use different Ubuntu releases. At the moment they are all the "noble",
        # which is also what would be desired, so we don't bother listing explicit ones.
        swift:
        - version: "6.2"
        - version: "6.1"
        - version: "6.0"
    container:
      image: swift:${{ matrix.swift.version }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: true
    - name: Update and install dependencies
      # Just ensure we have the latest `g++` for building protoc (since it is
      # built by SwiftPM), full dependencies available at
      # https://github.com/protocolbuffers/protobuf/blob/main/src/README.md
      #
      # `make` is needed for using our own `Makefile`.
      run: apt-get update && apt-get install -y make g++
    - name: Build
      run: make build -Xswiftc -warnings-as-errors
    - name: Test runtime
      run: make test-runtime -Xswiftc -warnings-as-errors
    - name: Test plugin
      run: make test-plugin
    - name: Test SPM plugin
      run: make test-spm-plugin
    - name: Compilation Tests
      run: make compile-tests

  api-breakage:
    name: Api Breakage Compared to main branch
    # Only on pull requests
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    container:
      # Test on the latest Swift release. This could run on all the support
      # Swift versions, but that doesn't seem worth it until there are Swift
      # version specific conditionals to justify it.
      image: swift:latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: true
    - name: Mark the workspace as safe
      # https://github.com/actions/checkout/issues/766
      run: git config --global --add safe.directory ${GITHUB_WORKSPACE}
    - name: Check for API breaking changes
      run: swift package diagnose-api-breaking-changes origin/main

  format-check:
    name: swift-format Check
    # Only on pull requests
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    container:
      # Use use the latest Swift release and that's the version of swift-format
      # people should use.
      image: swift:latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: true
    - name: Mark the workspace as safe
      # https://github.com/actions/checkout/issues/766
      run: git config --global --add safe.directory ${GITHUB_WORKSPACE}
    - name: Run format check
      run:  |
        set -eu
        git ls-files -z '*.swift' | xargs -0 swift format format --parallel --in-place
        GIT_PAGER='' git diff --exit-code '*.swift'
    - name: Run format lint check
      run:  |
        set -eu
        git ls-files -z '*.swift' | xargs -0 swift format lint --strict --parallel

  sanitizer_testing:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        sanitizer: ["address", "thread"]
        swiftpm_config: ["debug", "release"]
        exclude: #Â Excluded due to a clang crasher that is fixed in a more recent clang https://github.com/llvm/llvm-project/issues/95928
         - sanitizer: "address"
           swiftpm_config: "debug"
    container:
      # Test on the latest Swift release.
      image: swift:latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Test
      run: |
        set -eu
        # Trim out the generate files that are just compile tests, they take a while to compile and
        # are covered in core instead.
        rm Tests/SwiftProtobufTests/generated_swift_names*
        # On linux, the tests seem to always see leaks that don't show up on macOS. Disable the
        # leak detection and just assume it is a Linux Swift issue. This still gets validation
        # for other memory errors. Maybe https://github.com/swiftlang/swift/issues/49397
        if [ "${{ matrix.sanitizer }}" = "address" ] ; then
          export ASAN_OPTIONS=detect_leaks=0
        fi
        swift test -c ${{ matrix.swiftpm_config }} --sanitize=${{ matrix.sanitizer }}

  fuzzing_regressions:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        swiftpm_config: ["debug", "release"]
    container:
      # Test on the latest Swift release.
      image: swift:latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    - name: Build
      run: FuzzTesting/do_build.sh --${{ matrix.swiftpm_config }}-only --run-regressions
