name: Run Conformance Tests

# This workflow is a subset of the build.yml. It *only* try to run the
# conformance checks. It is triggered weekly on a cron to catch when new
# conformance tests are added and they don't pass.
#
# Without this workflow the new tests wouldn't be noticed until a PR was made.
#
# This workflow shares the caching logic with build.yml. It should serve to
# update a subset of the caches for when things do land on trunk. If that
# is deemed not worth it in the future, this can be simplify.

# NOTE: If making changes to most of the steps, please also look to update
# build.yml also.

on:
  schedule:
    # Every Sunday at 5am.
    - cron: '0 5 * * 0'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        swift: ["5.6.2"]
        ubuntu: ["focal"]
        # protobuf_git can reference a commit, tag, or branch
        # commit: "commits/6935eae45c99926a000ecbef0be20dfd3d159e71"
        # tag: "ref/tags/v3.11.4"
        # branch: "ref/heads/main"
        protobuf_git: ["ref/heads/main"]
    container:
      image: swift:${{ matrix.swift }}-${{ matrix.ubuntu }}
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        path: main
    - name: Update and install dependencies
      # dependencies from https://github.com/protocolbuffers/protobuf/blob/main/src/README.md
      # NOTE: zlib1g-dev is added to fix the Swift 5.0.x builds, when those builds aren't needed
      # that dep likely can be removed.
      run: |
        set -eu
        apt-get update
        apt-get install -y make g++
    # Can't simple install bazel or bazelisk via app-get because bazel doesn't
    # support focal yet - https://bazel.build/install/ubuntu
    - name: Setup Go
      uses: actions/setup-go@v3
      with:
        go-version: '>=1.18.0'
    - name: Install bazelisk/bazel
      run: go install github.com/bazelbuild/bazelisk@latest
    - name: Checkout protobuf repo
      uses: actions/checkout@v2
      with:
        repository: protocolbuffers/protobuf
        ref: ${{ matrix.protobuf_git }}
        path: protobuf
    - name: Build protobuf
      working-directory: protobuf
      run: bazelisk build -c opt //conformance:conformance_test_runner
    - name: Test conformance
      working-directory: main
      run: make test-conformance
