// Sources/protoc-gen-swift/NamespaceGenerator.swift - Namespace file generation
//
// Copyright (c) 2014 - 2025 Apple Inc. and the project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See LICENSE.txt for license information:
// https://github.com/apple/swift-protobuf/blob/main/LICENSE.txt
//
// -----------------------------------------------------------------------------
///
/// This provides the logic for generating a namespace.swift file containing
/// empty nested enum hierarchies for proto packages when using nested
/// namespace mode.
///
// -----------------------------------------------------------------------------

import SwiftProtobufPluginLibrary

/// Generates namespace.swift file containing empty nested enum hierarchy
struct NamespaceGenerator {
    let packages: Set<String>
    let generatorOptions: GeneratorOptions

    /// Generates the namespace file content
    func generateNamespaceFile() -> String {
        var printer = CodePrinter(addNewlines: true)

        // File header
        printer.print(
            "// DO NOT EDIT.",
            "// swift-format-ignore-file",
            "// swiftlint:disable all",
            "//",
            "// Namespace definitions for proto packages",
            "// Generated by protoc-gen-swift. DO NOT EDIT!",
            ""
        )

        // Build namespace tree from all packages
        let tree = buildNamespaceTree()

        // Generate nested enums
        generateNamespaceEnums(tree: tree, printer: &printer)

        return printer.content
    }

    /// Builds a tree structure from all package names
    private func buildNamespaceTree() -> NamespaceNode {
        let root = NamespaceNode(name: "")

        for package in packages {
            let components = NamingUtils.packageToNamespaceComponents(protoPackage: package)
            var current = root

            for component in components {
                if let child = current.children[component] {
                    current = child
                } else {
                    let child = NamespaceNode(name: component)
                    current.children[component] = child
                    current = child
                }
            }
        }

        return root
    }

    /// Recursively generates nested enum declarations
    private func generateNamespaceEnums(
        tree: NamespaceNode,
        printer: inout CodePrinter,
        depth: Int = 0
    ) {
        let visibility = generatorOptions.visibilitySourceSnippet
        let sortedChildren = tree.children.values.sorted { $0.name < $1.name }

        for (index, child) in sortedChildren.enumerated() {
            if depth > 0 && index > 0 {
                printer.print("")
            }

            printer.print("\(visibility)enum \(child.name) {")
            printer.indent()

            if !child.children.isEmpty {
                generateNamespaceEnums(tree: child, printer: &printer, depth: depth + 1)
            }

            printer.outdent()
            printer.print("}")
        }
    }
}

/// Tree node for building namespace hierarchy
private class NamespaceNode {
    let name: String
    var children: [String: NamespaceNode] = [:]

    init(name: String) {
        self.name = name
    }
}
